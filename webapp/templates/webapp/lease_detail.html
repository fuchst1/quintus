{% extends "webapp/base.html" %}
{% block page_title %}Mietvertrag{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">Mietvertrag – Details</h3>
    <a href="{% url 'lease_list' %}" class="btn btn-light">Zurück</a>
</div>

<div class="row g-4">
    <div class="col-12 col-xl-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="text-muted small">Einheit</div>
                        <div class="fw-semibold">{{ lease.unit }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Mieter</div>
                        <div class="fw-semibold">
                            {% for tenant in lease.tenants.all %}
                                {{ tenant.first_name }} {{ tenant.last_name }}{% if not forloop.last %}<br>{% endif %}
                            {% empty %}
                                — 
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Verwalter</div>
                        <div class="fw-semibold">{{ lease.manager|default:"—" }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Status</div>
                        <div class="fw-semibold">{{ lease.get_status_display }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Einzug</div>
                        <div class="fw-semibold">{{ lease.entry_date|date:"d.m.Y" }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Auszug</div>
                        <div class="fw-semibold">{{ lease.exit_date|date:"d.m.Y"|default:"—" }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Index-Typ</div>
                        <div class="fw-semibold">{% if lease.index_type == "vpi" %}Wertsicherung{% else %}{{ lease.get_index_type_display }}{% endif %}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Letzte Wertsicherung</div>
                        <div class="fw-semibold">{{ lease.last_index_adjustment|date:"d.m.Y"|default:"—" }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="text-muted small">Index-Basiswert</div>
                        <div class="fw-semibold">{{ lease.index_base_value|default:"—" }}</div>
                    </div>
                    <div class="col-12">
                        <div class="text-muted small">Erinnerungen</div>
                        {% if lease_reminder_items %}
                            <div class="d-flex flex-column gap-1">
                                {% for reminder in lease_reminder_items %}
                                    <span class="badge text-start lease-reminder-badge {% if reminder.is_overdue %}text-bg-danger{% else %}text-bg-warning{% endif %}">
                                        {% if reminder.rule_code == "vpi_indexation" %}Wertsicherung{% else %}{{ reminder.rule_title }}{% endif %} · {{ reminder.due_date|date:"d.m.Y" }}
                                    </span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="fw-semibold">—</div>
                        {% endif %}
                    </div>
                </div>

                <hr class="my-4">

                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-muted small">HMZ Netto</div>
                        <div class="fw-semibold">{{ lease.net_rent }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">BK Netto</div>
                        <div class="fw-semibold">{{ lease.operating_costs_net }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Heizung Netto</div>
                        <div class="fw-semibold">{{ lease.heating_costs_net }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Kaution</div>
                        <div class="fw-semibold">{{ lease.deposit }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">HMZ/m²</div>
                        <div class="fw-semibold">{{ lease.rent_per_sqm }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Bruttomiete (berechnet)</div>
                        <div class="fw-semibold">{{ lease.total_gross_rent }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Mietkonto</h5>
                    <a href="{% url 'buchung_create' %}?lease={{ lease.pk }}" class="btn btn-sm btn-outline-primary">
                        SOLL-Buchung hinzufügen
                    </a>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="text-muted small">Summe Soll</div>
                        <div class="fw-semibold">{{ soll_summe }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Summe Haben</div>
                        <div class="fw-semibold">{{ haben_summe }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-muted small">Kontostand (Haben - Soll)</div>
                        <div class="fw-semibold {% if kontostand < 0 %}text-danger{% elif kontostand > 0 %}text-success{% else %}text-muted{% endif %}">
                            {{ kontostand }}
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Datum</th>
                                <th>Typ</th>
                                <th>Kategorie</th>
                                <th>Buchungstext</th>
                                <th class="text-end">Bewegung</th>
                                <th class="text-end">Kontostand</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in konto_rows %}
                            {% if row.kind == "booking" %}
                            {% with buchung=row.buchung %}
                            <tr>
                                <td>{{ buchung.datum|date:"d.m.Y" }}</td>
                                <td>{{ buchung.get_typ_display }}</td>
                                <td>{{ buchung.get_kategorie_display }}</td>
                                <td>{{ buchung.buchungstext }}</td>
                                <td class="text-end {% if buchung.kontobewegung < 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ buchung.kontobewegung }}
                                </td>
                                <td class="text-end {% if buchung.kontostand < 0 %}text-danger{% elif buchung.kontostand > 0 %}text-success{% else %}text-muted{% endif %}">
                                    {{ buchung.kontostand }}
                                </td>
                            </tr>
                            {% endwith %}
                            {% else %}
                            <tr class="table-secondary">
                                <td colspan="3" class="fw-semibold">Monatsabschluss {{ row.month_label }}</td>
                                <td class="small">
                                    Soll {{ row.month_soll }} | Haben {{ row.month_haben }}
                                    {% if row.offen > 0 %}| Offen {{ row.offen }}{% endif %}
                                </td>
                                <td class="text-end fw-semibold {% if row.month_delta < 0 %}text-danger{% elif row.month_delta > 0 %}text-success{% else %}text-muted{% endif %}">
                                    {{ row.month_delta }}
                                </td>
                                <td class="text-end fw-semibold {% if row.month_end_kontostand < 0 %}text-danger{% elif row.month_end_kontostand > 0 %}text-success{% else %}text-muted{% endif %}">
                                    {{ row.month_end_kontostand }}
                                </td>
                            </tr>
                            {% endif %}
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">Keine Buchungen vorhanden.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-xl-4">
        {% include "webapp/partials/_attachments_panel.html" with attachments_panel=attachments_panel attachments_panel_inline=True %}
    </div>
</div>
{% endblock %}
