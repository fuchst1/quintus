{% extends "webapp/base.html" %}
{% load l10n %}
{% block page_title %}Buchungen{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">Buchungen</h3>
    <div class="d-flex gap-2">
        <a
            id="buchungExportExcelButton"
            data-base-url="{% url 'buchung_export_excel' %}"
            href="{% if request.GET.urlencode %}{% url 'buchung_export_excel' %}?{{ request.GET.urlencode }}{% else %}{% url 'buchung_export_excel' %}{% endif %}"
            class="btn btn-outline-success shadow-sm"
        >
            <i class="bi bi-file-earmark-excel me-1"></i> Excel
        </a>
        <a href="{% url 'buchung_create' %}" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> Neue Buchung
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-6 col-lg-4">
                <label for="buchungSearch" class="form-label mb-1">Suchen</label>
                <input
                    id="buchungSearch"
                    type="search"
                    class="form-control"
                    placeholder="Text, Vertrag, Kategorie, Typ"
                    autocomplete="off"
                    value="{{ selected_search_query }}"
                >
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <label for="buchungKategorieFilter" class="form-label mb-1">Kategorie</label>
                <select id="buchungKategorieFilter" class="form-select" data-initial="{{ selected_category_filter }}">
                    <option value="">Alle Kategorien</option>
                </select>
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <form method="get" class="mb-0">
                    {% if bank_transaktion_id %}
                    <input type="hidden" name="bank_transaktion" value="{{ bank_transaktion_id }}">
                    {% endif %}
                    {% if selected_search_query %}
                    <input type="hidden" name="q" value="{{ selected_search_query }}">
                    {% endif %}
                    {% if selected_category_filter %}
                    <input type="hidden" name="kategorie" value="{{ selected_category_filter }}">
                    {% endif %}
                    <input type="hidden" name="jahr" value="{{ selected_year }}">
                    <label for="buchungPropertyFilter" class="form-label mb-1">Liegenschaft</label>
                    <select id="buchungPropertyFilter" name="liegenschaft" class="form-select" onchange="this.form.submit()">
                        <option value="all" {% if selected_property_filter_value == "all" %}selected{% endif %}>Alle Liegenschaften</option>
                        {% for property in properties %}
                        <option value="{{ property.pk }}" {% if property.pk|stringformat:"s" == selected_property_filter_value %}selected{% endif %}>{{ property.name }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <form method="get" class="mb-0">
                    {% if bank_transaktion_id %}
                    <input type="hidden" name="bank_transaktion" value="{{ bank_transaktion_id }}">
                    {% endif %}
                    {% if selected_search_query %}
                    <input type="hidden" name="q" value="{{ selected_search_query }}">
                    {% endif %}
                    {% if selected_category_filter %}
                    <input type="hidden" name="kategorie" value="{{ selected_category_filter }}">
                    {% endif %}
                    {% if selected_property_filter_value %}
                    <input type="hidden" name="liegenschaft" value="{{ selected_property_filter_value }}">
                    {% endif %}
                    <label for="buchungYearFilter" class="form-label mb-1">Jahr</label>
                    <select id="buchungYearFilter" name="jahr" class="form-select" onchange="this.form.submit()">
                        {% for year in year_choices %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                        {% empty %}
                        <option value="{{ selected_year }}">{{ selected_year }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="col-md-3 col-lg-2 text-lg-end">
                <div id="buchungCount" class="small text-muted"></div>
                <div class="small fw-semibold text-dark">Summe gefiltert:</div>
                <div id="buchungFilteredSumNetto" class="small text-dark">
                    Netto: € {{ filtered_sum_netto|floatformat:2 }}
                </div>
                <div id="buchungFilteredSumBrutto" class="small text-dark">
                    Brutto: € {{ filtered_sum_brutto|floatformat:2 }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="text-center">Aktion</th>
                        <th class="ps-4">
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-dark table-sort fw-semibold" data-sort-key="datum">
                                Datum <span class="sort-indicator" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-dark table-sort fw-semibold" data-sort-key="mietvertrag">
                                Mietvertrag <span class="sort-indicator" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th class="text-end pe-4">
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-dark table-sort fw-semibold" data-sort-key="netto">
                                Netto <span class="sort-indicator" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th class="text-end pe-4">
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-dark table-sort fw-semibold" data-sort-key="brutto">
                                Brutto <span class="sort-indicator" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-dark table-sort fw-semibold" data-sort-key="kategorie">
                                Kategorie <span class="sort-indicator" aria-hidden="true"></span>
                            </button>
                        </th>
                        <th>
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-dark table-sort fw-semibold" data-sort-key="buchungstext">
                                Buchungstext <span class="sort-indicator" aria-hidden="true"></span>
                            </button>
                        </th>
                    </tr>
                </thead>
                <tbody id="buchungTableBody">
                    {% for buchung in buchungen %}
                    <tr
                        data-row="1"
                        data-id="{{ buchung.pk }}"
                        data-search="{{ buchung.datum|date:'d.m.Y' }} {{ buchung.mietervertrag }} {{ buchung.get_kategorie_display }} {{ buchung.get_typ_display }} {{ buchung.buchungstext }}"
                        data-kategorie="{{ buchung.kategorie }}"
                        data-kategorie-label="{{ buchung.get_kategorie_display }}"
                        data-typ="{{ buchung.typ }}"
                        data-typ-label="{{ buchung.get_typ_display }}"
                        data-datum="{{ buchung.datum|date:'Y-m-d' }}"
                        data-netto="{{ buchung.netto|unlocalize }}"
                        data-brutto="{{ buchung.brutto|unlocalize }}"
                        data-mietvertrag="{% if buchung.mietervertrag %}{{ buchung.mietervertrag }}{% endif %}"
                        data-buchungstext="{{ buchung.buchungstext }}"
                    >
                        <td class="text-center">
                            <a href="{% url 'buchung_update' buchung.pk %}" class="btn btn-sm btn-outline-secondary me-1">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <a href="{% url 'buchung_delete' buchung.pk %}" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                        <td class="ps-4">{{ buchung.datum|date:"d.m.Y" }}</td>
                        <td>{{ buchung.mietervertrag }}</td>
                        <td class="text-end pe-4">
                            <span class="fw-semibold {% if buchung.netto < 0 %}text-danger{% elif buchung.netto > 0 %}text-success{% else %}text-muted{% endif %}">
                                {{ buchung.netto }}
                            </span>
                        </td>
                        <td class="text-end pe-4">
                            <span class="fw-semibold {% if buchung.brutto < 0 %}text-danger{% elif buchung.brutto > 0 %}text-success{% else %}text-muted{% endif %}">
                                {{ buchung.brutto }}
                            </span>
                        </td>
                        <td>{{ buchung.get_kategorie_display }}</td>
                        <td>{{ buchung.buchungstext }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5 text-muted">Keine Buchungen gefunden.</td>
                    </tr>
                    {% endfor %}
                    <tr id="buchungNoResults" class="d-none">
                        <td colspan="7" class="text-center py-5 text-muted">Keine Treffer für den aktuellen Filter.</td>
                    </tr>
                    <tr id="buchungSummaryRow" class="table-light">
                        <td colspan="7" class="text-end pe-4 fw-semibold">
                            Summe gefiltert:
                            Netto <span id="buchungFilteredNettoCell">€ {{ filtered_sum_netto|floatformat:2 }}</span>
                            · Brutto <span id="buchungFilteredBruttoCell">€ {{ filtered_sum_brutto|floatformat:2 }}</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(() => {
    const tableBody = document.getElementById("buchungTableBody");
    if (!tableBody) {
        return;
    }

    const rows = Array.from(tableBody.querySelectorAll("tr[data-row='1']"));
    const searchInput = document.getElementById("buchungSearch");
    const categoryFilter = document.getElementById("buchungKategorieFilter");
    const countElement = document.getElementById("buchungCount");
    const sumNettoElement = document.getElementById("buchungFilteredSumNetto");
    const sumBruttoElement = document.getElementById("buchungFilteredSumBrutto");
    const noResultsRow = document.getElementById("buchungNoResults");
    const summaryRow = document.getElementById("buchungSummaryRow");
    const summaryNettoCell = document.getElementById("buchungFilteredNettoCell");
    const summaryBruttoCell = document.getElementById("buchungFilteredBruttoCell");
    const exportButton = document.getElementById("buchungExportExcelButton");
    const exportBaseUrl = exportButton ? exportButton.dataset.baseUrl : "";
    const sortButtons = Array.from(document.querySelectorAll(".table-sort"));
    const currencyFormatter = new Intl.NumberFormat("de-AT", {
        style: "currency",
        currency: "EUR",
    });

    const state = {
        sortKey: "datum",
        sortDirection: "desc",
    };

    function normalize(value) {
        return String(value || "").toLowerCase().trim();
    }

    function parseNumeric(value) {
        const raw = String(value || "").trim();
        if (!raw) {
            return 0;
        }
        let normalized = raw;
        if (normalized.includes(",") && normalized.includes(".")) {
            normalized = normalized.replace(/\./g, "").replace(",", ".");
        } else if (normalized.includes(",")) {
            normalized = normalized.replace(",", ".");
        }
        const number = Number.parseFloat(normalized);
        return Number.isFinite(number) ? number : 0;
    }

    function compareRows(a, b) {
        const directionFactor = state.sortDirection === "asc" ? 1 : -1;
        const key = state.sortKey;

        let left;
        let right;

        if (key === "brutto") {
            left = parseNumeric(a.dataset.brutto);
            right = parseNumeric(b.dataset.brutto);
            return (left - right) * directionFactor;
        }
        if (key === "netto") {
            left = parseNumeric(a.dataset.netto);
            right = parseNumeric(b.dataset.netto);
            return (left - right) * directionFactor;
        }

        if (key === "datum") {
            left = a.dataset.datum || "";
            right = b.dataset.datum || "";
            return left.localeCompare(right, "de") * directionFactor;
        }

        if (key === "mietvertrag") {
            left = normalize(a.dataset.mietvertrag);
            right = normalize(b.dataset.mietvertrag);
            return left.localeCompare(right, "de", { sensitivity: "base" }) * directionFactor;
        }

        if (key === "kategorie") {
            left = normalize(a.dataset.kategorieLabel);
            right = normalize(b.dataset.kategorieLabel);
            return left.localeCompare(right, "de", { sensitivity: "base" }) * directionFactor;
        }

        if (key === "typ") {
            left = normalize(a.dataset.typLabel);
            right = normalize(b.dataset.typLabel);
            return left.localeCompare(right, "de", { sensitivity: "base" }) * directionFactor;
        }

        left = normalize(a.dataset.buchungstext);
        right = normalize(b.dataset.buchungstext);
        return left.localeCompare(right, "de", { sensitivity: "base" }) * directionFactor;
    }

    function fillSelect(selectElement, valuesWithLabel) {
        const keys = Array.from(valuesWithLabel.keys()).sort((a, b) => {
            const left = normalize(valuesWithLabel.get(a));
            const right = normalize(valuesWithLabel.get(b));
            return left.localeCompare(right, "de", { sensitivity: "base" });
        });
        for (const key of keys) {
            const option = document.createElement("option");
            option.value = key;
            option.textContent = valuesWithLabel.get(key);
            selectElement.appendChild(option);
        }
    }

    const categoryValues = new Map();
    for (const row of rows) {
        if (row.dataset.kategorie) {
            categoryValues.set(row.dataset.kategorie, row.dataset.kategorieLabel || row.dataset.kategorie);
        }
    }
    fillSelect(categoryFilter, categoryValues);
    if (categoryFilter.dataset.initial) {
        categoryFilter.value = categoryFilter.dataset.initial;
    }

    function updateSortIndicators() {
        for (const button of sortButtons) {
            const indicator = button.querySelector(".sort-indicator");
            if (!indicator) {
                continue;
            }
            if (button.dataset.sortKey !== state.sortKey) {
                indicator.textContent = "";
                indicator.className = "sort-indicator text-muted";
                continue;
            }
            indicator.textContent = state.sortDirection === "asc" ? "▲" : "▼";
            indicator.className = "sort-indicator text-primary";
        }
    }

    function applyFiltersAndSorting() {
        const searchTerm = normalize(searchInput.value);
        const categoryValue = categoryFilter.value;

        const visibleRows = [];
        for (const row of rows) {
            const matchesSearch = !searchTerm || normalize(row.dataset.search).includes(searchTerm);
            const matchesCategory = !categoryValue || row.dataset.kategorie === categoryValue;
            const isVisible = matchesSearch && matchesCategory;
            row.classList.toggle("d-none", !isVisible);
            if (isVisible) {
                visibleRows.push(row);
            }
        }

        visibleRows.sort(compareRows);
        for (const row of visibleRows) {
            tableBody.appendChild(row);
        }
        if (noResultsRow) {
            tableBody.appendChild(noResultsRow);
            noResultsRow.classList.toggle("d-none", visibleRows.length > 0);
        }
        if (summaryRow) {
            tableBody.appendChild(summaryRow);
        }

        if (countElement) {
            countElement.textContent = `${visibleRows.length} von ${rows.length} Buchungen`;
        }
        const filteredSumNetto = visibleRows.reduce(
            (sum, row) => sum + parseNumeric(row.dataset.netto),
            0,
        );
        const filteredSumBrutto = visibleRows.reduce(
            (sum, row) => sum + parseNumeric(row.dataset.brutto),
            0,
        );
        if (sumNettoElement) {
            sumNettoElement.textContent = `Netto: ${currencyFormatter.format(filteredSumNetto)}`;
        }
        if (sumBruttoElement) {
            sumBruttoElement.textContent = `Brutto: ${currencyFormatter.format(filteredSumBrutto)}`;
        }
        if (summaryNettoCell) {
            summaryNettoCell.textContent = currencyFormatter.format(filteredSumNetto);
        }
        if (summaryBruttoCell) {
            summaryBruttoCell.textContent = currencyFormatter.format(filteredSumBrutto);
        }
        if (exportButton && exportBaseUrl) {
            const params = new URLSearchParams(window.location.search);
            params.delete("ids");
            if (searchInput.value.trim()) {
                params.set("q", searchInput.value.trim());
            } else {
                params.delete("q");
            }
            if (categoryFilter.value) {
                params.set("kategorie", categoryFilter.value);
            } else {
                params.delete("kategorie");
            }
            const selectedIds = visibleRows.map((row) => row.dataset.id).filter((value) => Boolean(value));
            if (selectedIds.length > 0) {
                params.set("ids", selectedIds.join(","));
            } else {
                params.set("ids", "0");
            }
            const query = params.toString();
            exportButton.href = query ? `${exportBaseUrl}?${query}` : exportBaseUrl;
        }

        updateSortIndicators();
    }

    let frameRequested = false;
    function scheduleApply() {
        if (frameRequested) {
            return;
        }
        frameRequested = true;
        window.requestAnimationFrame(() => {
            frameRequested = false;
            applyFiltersAndSorting();
        });
    }

    searchInput.addEventListener("input", scheduleApply);
    categoryFilter.addEventListener("change", scheduleApply);

    for (const button of sortButtons) {
        button.addEventListener("click", () => {
            const nextKey = button.dataset.sortKey;
            if (!nextKey) {
                return;
            }
            if (state.sortKey === nextKey) {
                state.sortDirection = state.sortDirection === "asc" ? "desc" : "asc";
            } else {
                state.sortKey = nextKey;
                state.sortDirection = nextKey === "datum" ? "desc" : "asc";
            }
            scheduleApply();
        });
    }

    applyFiltersAndSorting();
})();
</script>
{% endblock %}
