{% extends "webapp/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-hero card border-0 shadow-sm mb-4">
    <div class="card-body p-4 p-lg-5">
        <div class="row align-items-center g-3">
            <div class="col-lg-8">
                <h1 class="h3 text-dark mb-2">Übersicht</h1>
                <p class="text-muted mb-0">
                    {% if user.is_authenticated %}
                        Hallo <strong>{{ user.username }}</strong>, hier ist der aktuelle Status deiner Hausverwaltung.
                    {% else %}
                        Willkommen im öffentlichen Bereich der Hausverwaltung.
                    {% endif %}
                </p>
            </div>
            <div class="col-lg-4 text-lg-end">
                <a href="{% url 'offene_posten' %}" class="btn btn-outline-primary me-2 mb-2 mb-lg-0">
                    <i class="bi bi-exclamation-triangle me-1"></i> Offene Posten
                </a>
                <a href="{% url 'buchung_create' %}" class="btn btn-primary mb-2 mb-lg-0">
                    <i class="bi bi-plus-circle me-1"></i> Neue Buchung
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-2">
    <div class="col-6 col-xl-3">
        <div class="card border-0 shadow-sm card-box h-100">
            <div class="card-body text-center py-4">
                <div class="dashboard-kpi-icon text-primary"><i class="bi bi-buildings"></i></div>
                <h5 class="text-muted text-uppercase small fw-bold mb-1">Liegenschaften</h5>
                <h2 class="display-6 fw-bold text-primary mb-0">{{ stats.properties }}</h2>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card border-0 shadow-sm card-box h-100">
            <div class="card-body text-center py-4">
                <div class="dashboard-kpi-icon text-success"><i class="bi bi-grid-1x2"></i></div>
                <h5 class="text-muted text-uppercase small fw-bold mb-1">Einheiten</h5>
                <h2 class="display-6 fw-bold text-success mb-0">{{ stats.units }}</h2>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card border-0 shadow-sm card-box h-100">
            <div class="card-body text-center py-4">
                <div class="dashboard-kpi-icon text-info"><i class="bi bi-person-badge"></i></div>
                <h5 class="text-muted text-uppercase small fw-bold mb-1">Eigentümer</h5>
                <h2 class="display-6 fw-bold text-info mb-0">{{ stats.owners }}</h2>
            </div>
        </div>
    </div>

    <div class="col-6 col-xl-3">
        <div class="card border-0 shadow-sm card-box h-100">
            <div class="card-body text-center py-4">
                <div class="dashboard-kpi-icon text-danger"><i class="bi bi-door-open"></i></div>
                <h5 class="text-muted text-uppercase small fw-bold mb-1">Freie Einheiten</h5>
                <h2 class="display-6 fw-bold text-danger mb-0">{{ stats.vacant_units }}</h2>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold mb-1">Aktive Mietverträge</div>
                <div class="h4 mb-0">{{ stats.active_leases }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold mb-1">Mieter</div>
                <div class="h4 mb-0">{{ stats.tenants }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold mb-1">Verwalter</div>
                <div class="h4 mb-0">{{ stats.managers }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="text-muted small text-uppercase fw-semibold mb-1">Offener Gesamtbetrag</div>
                <div class="h4 mb-0 text-danger">€ {{ finance.open_amount_total|floatformat:2 }}</div>
                <div class="small text-muted">{{ finance.overdue_leases }} Verträge mit Rückstand</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-xl-6">
        <div class="card border-0 shadow-sm h-100 dashboard-chart-card">
            <div class="card-body">
                <div class="dashboard-chart-card__header">
                    <div>
                        <h3 class="h6 fw-bold mb-1">Netto-Miete pro Jahr (IST)</h3>
                        <p class="dashboard-chart-card__subtitle mb-0">Nur tatsächlich eingegangene HMZ-Buchungen.</p>
                    </div>
                    <div class="dashboard-chart-card__meta">
                        <div class="dashboard-chart-card__meta-label">{{ finance_charts.latest_year }}</div>
                        <div class="dashboard-chart-card__meta-value">€ {{ finance_charts.latest_rent_net|floatformat:2 }}</div>
                    </div>
                </div>
                {% if finance_charts.has_yearly_data %}
                    <div class="dashboard-chart-canvas-wrap mt-3">
                        <canvas id="dashboardRentYearChart" aria-label="Netto-Miete pro Jahr"></canvas>
                    </div>
                {% else %}
                    <div class="dashboard-chart-empty mt-3">
                        Noch keine HMZ-Zahlungseingänge vorhanden.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card border-0 shadow-sm h-100 dashboard-chart-card">
            <div class="card-body">
                <div class="dashboard-chart-card__header">
                    <div>
                        <h3 class="h6 fw-bold mb-1">BK/HK Netto: Einnahmen vs. Ausgaben (Jahr)</h3>
                        <p class="dashboard-chart-card__subtitle mb-0">Einnahmen aus IST-Buchungen (BK/HK), Ausgaben aus BK-Belegen.</p>
                    </div>
                    <div class="dashboard-chart-kpi-list">
                        <span class="dashboard-chart-kpi-item">
                            <span>Einnahmen</span>
                            <strong class="text-success">€ {{ finance_charts.latest_bk_income_net|floatformat:2 }}</strong>
                        </span>
                        <span class="dashboard-chart-kpi-item">
                            <span>Ausgaben</span>
                            <strong class="text-danger">€ {{ finance_charts.latest_bk_expense_net|floatformat:2 }}</strong>
                        </span>
                        <span class="dashboard-chart-kpi-item">
                            <span>Saldo</span>
                            <strong class="{% if finance_charts.latest_bk_balance_net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                € {{ finance_charts.latest_bk_balance_net|floatformat:2 }}
                            </strong>
                        </span>
                    </div>
                </div>
                {% if finance_charts.has_yearly_data %}
                    <div class="dashboard-chart-canvas-wrap mt-3">
                        <canvas id="dashboardBkYearChart" aria-label="BK und HK Einnahmen sowie BK-Ausgaben pro Jahr"></canvas>
                    </div>
                {% else %}
                    <div class="dashboard-chart-empty mt-3">
                        Noch keine BK/HK-Daten vorhanden.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm dashboard-chart-card">
            <div class="card-body">
                <div class="dashboard-chart-card__header">
                    <div>
                        <h3 class="h6 fw-bold mb-1">Monatsverlauf {{ finance_charts.current_year }} (Netto)</h3>
                        <p class="dashboard-chart-card__subtitle mb-0">Mieteingänge sowie BK/HK-Einnahmen im Vergleich zu BK-Ausgaben.</p>
                    </div>
                    <div class="dashboard-chart-kpi-list">
                        <span class="dashboard-chart-kpi-item">
                            <span>Miete</span>
                            <strong class="text-primary">€ {{ finance_charts.current_year_rent_net|floatformat:2 }}</strong>
                        </span>
                        <span class="dashboard-chart-kpi-item">
                            <span>BK/HK</span>
                            <strong class="text-success">€ {{ finance_charts.current_year_bk_income_net|floatformat:2 }}</strong>
                        </span>
                        <span class="dashboard-chart-kpi-item">
                            <span>BK-Ausgaben</span>
                            <strong class="text-danger">€ {{ finance_charts.current_year_bk_expense_net|floatformat:2 }}</strong>
                        </span>
                        <span class="dashboard-chart-kpi-item">
                            <span>BK-Saldo</span>
                            <strong class="{% if finance_charts.current_year_bk_balance_net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                € {{ finance_charts.current_year_bk_balance_net|floatformat:2 }}
                            </strong>
                        </span>
                    </div>
                </div>
                {% if finance_charts.has_monthly_data %}
                    <div class="dashboard-chart-canvas-wrap dashboard-chart-canvas-wrap--wide mt-3">
                        <canvas id="dashboardMonthlyFinanceChart" aria-label="Monatlicher Finanzverlauf"></canvas>
                    </div>
                {% else %}
                    <div class="dashboard-chart-empty mt-3">
                        Für {{ finance_charts.current_year }} liegen noch keine Monatsdaten vor.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h3 class="h6 fw-bold mb-3">Schnellzugriff</h3>
                <div class="d-grid gap-2">
                    <a href="{% url 'property_create' %}" class="btn btn-light text-start">
                        <i class="bi bi-plus-square me-2"></i> Neue Liegenschaft
                    </a>
                    <a href="{% url 'unit_create' %}" class="btn btn-light text-start">
                        <i class="bi bi-plus-square-dotted me-2"></i> Neue Einheit
                    </a>
                    <a href="{% url 'lease_create' %}" class="btn btn-light text-start">
                        <i class="bi bi-file-earmark-plus me-2"></i> Neuer Mietvertrag
                    </a>
                    <a href="{% url 'betriebskostenbeleg_create' %}" class="btn btn-light text-start">
                        <i class="bi bi-receipt-cutoff me-2"></i> Neuer BK-Beleg
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h6 fw-bold mb-0">Letzte Buchungen</h3>
                    <a href="{% url 'buchung_list' %}" class="small text-decoration-none">Alle anzeigen</a>
                </div>
                {% if recent_bookings %}
                    <div class="list-group list-group-flush">
                        {% for booking in recent_bookings %}
                            <div class="list-group-item px-0">
                                <div class="d-flex justify-content-between">
                                    <div class="fw-semibold">{{ booking.get_kategorie_display }}</div>
                                    <div class="small text-muted">{{ booking.datum|date:"d.m.Y" }}</div>
                                </div>
                                <div class="small text-muted">{{ booking.buchungstext }}</div>
                                <div class="small fw-semibold {% if booking.typ == 'soll' %}text-danger{% else %}text-success{% endif %}">
                                    {% if booking.typ == 'soll' %}-{% else %}+{% endif %} € {{ booking.brutto|floatformat:2 }}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small mb-0">Noch keine Buchungen vorhanden.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h6 fw-bold mb-0">Demnächst endende Verträge</h3>
                    <a href="{% url 'lease_list' %}" class="small text-decoration-none">Alle anzeigen</a>
                </div>
                {% if upcoming_exits %}
                    <div class="list-group list-group-flush">
                        {% for lease in upcoming_exits %}
                            <div class="list-group-item px-0">
                                <div class="fw-semibold">{{ lease.unit.property.name }} · {{ lease.unit.name }}</div>
                                <div class="small text-muted">
                                    {% for tenant in lease.tenants.all %}
                                        {{ tenant }}{% if not forloop.last %}, {% endif %}
                                    {% empty %}
                                        Kein Mieter hinterlegt
                                    {% endfor %}
                                </div>
                                <div class="small">
                                    Auszug am <span class="fw-semibold">{{ lease.exit_date|date:"d.m.Y" }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small mb-0">Keine angekündigten Auszüge.</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 dashboard-reminder-card">
            <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                    <h3 class="h6 fw-bold mb-0">Erinnerungen</h3>
                    <a href="{% url 'reminder_settings' %}" class="small text-decoration-none">Einstellungen</a>
                </div>
                <div class="dashboard-reminder-summary mb-2">
                    <span class="dashboard-reminder-summary-item">
                        Offen gesamt <strong>{{ reminder_summary.total }}</strong>
                    </span>
                    <span class="dashboard-reminder-summary-item dashboard-reminder-summary-item-danger">
                        Überfällig <strong>{{ reminder_summary.overdue }}</strong>
                    </span>
                    <span class="dashboard-reminder-summary-item dashboard-reminder-summary-item-warning">
                        Ohne E-Mail-Ziel <strong>{{ reminder_summary.without_email }}</strong>
                    </span>
                </div>

                {% if upcoming_reminders %}
                    <div class="list-group list-group-flush dashboard-reminder-list">
                        {% for reminder in upcoming_reminders|slice:":4" %}
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center gap-2">
                                    <div class="small text-truncate dashboard-reminder-main">
                                        <span class="fw-semibold">{{ reminder.rule_title }}</span>
                                        <span class="text-muted">· {{ reminder.lease_label }}</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                        <span class="small text-muted">{{ reminder.due_date|date:"d.m.Y" }}</span>
                                        <span class="badge dashboard-reminder-status-badge {% if reminder.is_overdue %}text-bg-danger{% else %}text-bg-warning{% endif %}">
                                            {% if reminder.is_overdue %}
                                                Überfällig
                                            {% elif reminder.days_until_due == 0 %}
                                                Heute
                                            {% else %}
                                                {{ reminder.days_until_due }} T.
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    {% if reminder_summary.total > 4 %}
                        <div class="small text-muted mt-2">{{ reminder_summary.total|add:"-4" }} weitere Erinnerungen.</div>
                    {% endif %}
                {% else %}
                    <p class="text-muted small mb-0">Derzeit sind keine Erinnerungen offen.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="h6 fw-bold mb-0">Liegenschaften im Überblick</h3>
                    <a href="{% url 'property_list' %}" class="small text-decoration-none">Zur Liste</a>
                </div>
                {% if property_cards %}
                    <div class="row g-3">
                        {% for property in property_cards %}
                            <div class="col-md-6 col-xl-4">
                                <div class="dashboard-property-card p-3 rounded-3 h-100">
                                    <div class="fw-semibold">{{ property.name }}</div>
                                    <div class="small text-muted mb-2">{{ property.zip_code }} {{ property.city }}</div>
                                    <div class="small">
                                        Einheiten: <strong>{{ property.unit_count }}</strong><br>
                                        Vermietet: <strong>{{ property.rented_unit_count }}</strong><br>
                                        Frei: <strong>{{ property.vacant_unit_count }}</strong>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small mb-0">Keine Liegenschaften angelegt.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

{{ finance_charts.year_labels|json_script:"dashboard-year-labels" }}
{{ finance_charts.rent_net_yearly|json_script:"dashboard-rent-year-values" }}
{{ finance_charts.bk_income_net_yearly|json_script:"dashboard-bk-income-year-values" }}
{{ finance_charts.bk_expense_net_yearly|json_script:"dashboard-bk-expense-year-values" }}
{{ finance_charts.month_labels|json_script:"dashboard-month-labels" }}
{{ finance_charts.rent_net_monthly|json_script:"dashboard-rent-month-values" }}
{{ finance_charts.bk_income_net_monthly|json_script:"dashboard-bk-income-month-values" }}
{{ finance_charts.bk_expense_net_monthly|json_script:"dashboard-bk-expense-month-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
(() => {
    if (typeof Chart === "undefined") {
        return;
    }

    const readJson = (id, fallback = []) => {
        const node = document.getElementById(id);
        if (!node) {
            return fallback;
        }
        try {
            return JSON.parse(node.textContent);
        } catch (_error) {
            return fallback;
        }
    };

    const toNumberArray = (values) => {
        if (!Array.isArray(values)) {
            return [];
        }
        return values.map((value) => Number(value) || 0);
    };

    const yearLabels = readJson("dashboard-year-labels");
    const rentYearValues = toNumberArray(readJson("dashboard-rent-year-values"));
    const bkIncomeYearValues = toNumberArray(readJson("dashboard-bk-income-year-values"));
    const bkExpenseYearValues = toNumberArray(readJson("dashboard-bk-expense-year-values"));

    const monthLabels = readJson("dashboard-month-labels");
    const rentMonthValues = toNumberArray(readJson("dashboard-rent-month-values"));
    const bkIncomeMonthValues = toNumberArray(readJson("dashboard-bk-income-month-values"));
    const bkExpenseMonthValues = toNumberArray(readJson("dashboard-bk-expense-month-values"));

    const euroAxisFormatter = new Intl.NumberFormat("de-AT", {
        style: "currency",
        currency: "EUR",
        maximumFractionDigits: 0,
    });
    const euroTooltipFormatter = new Intl.NumberFormat("de-AT", {
        style: "currency",
        currency: "EUR",
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
    });

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: "index",
            intersect: false,
        },
        plugins: {
            legend: {
                labels: {
                    usePointStyle: true,
                },
            },
            tooltip: {
                callbacks: {
                    label: (ctx) => `${ctx.dataset.label}: ${euroTooltipFormatter.format(ctx.parsed.y || 0)}`,
                },
            },
        },
        scales: {
            x: {
                grid: {
                    color: "rgba(30, 58, 95, 0.05)",
                },
            },
            y: {
                beginAtZero: true,
                ticks: {
                    callback: (value) => euroAxisFormatter.format(value),
                },
                grid: {
                    color: "rgba(30, 58, 95, 0.1)",
                },
            },
        },
    };

    const rentYearCanvas = document.getElementById("dashboardRentYearChart");
    if (rentYearCanvas && yearLabels.length) {
        new Chart(rentYearCanvas, {
            type: "line",
            data: {
                labels: yearLabels,
                datasets: [
                    {
                        label: "Netto-Miete (IST)",
                        data: rentYearValues,
                        borderColor: "#1e3a5f",
                        backgroundColor: "rgba(30, 58, 95, 0.15)",
                        borderWidth: 2,
                        tension: 0.28,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 4,
                    },
                ],
            },
            options: commonOptions,
        });
    }

    const bkYearCanvas = document.getElementById("dashboardBkYearChart");
    if (bkYearCanvas && yearLabels.length) {
        new Chart(bkYearCanvas, {
            type: "bar",
            data: {
                labels: yearLabels,
                datasets: [
                    {
                        label: "BK/HK Einnahmen",
                        data: bkIncomeYearValues,
                        backgroundColor: "rgba(25, 135, 84, 0.75)",
                        borderColor: "#198754",
                        borderWidth: 1,
                        borderRadius: 6,
                    },
                    {
                        label: "BK-Ausgaben",
                        data: bkExpenseYearValues,
                        backgroundColor: "rgba(220, 53, 69, 0.72)",
                        borderColor: "#dc3545",
                        borderWidth: 1,
                        borderRadius: 6,
                    },
                ],
            },
            options: commonOptions,
        });
    }

    const monthlyCanvas = document.getElementById("dashboardMonthlyFinanceChart");
    if (monthlyCanvas && monthLabels.length) {
        new Chart(monthlyCanvas, {
            type: "line",
            data: {
                labels: monthLabels,
                datasets: [
                    {
                        label: "Netto-Miete",
                        data: rentMonthValues,
                        borderColor: "#1e3a5f",
                        backgroundColor: "rgba(30, 58, 95, 0.12)",
                        borderWidth: 2,
                        tension: 0.28,
                        fill: false,
                        pointRadius: 2.5,
                    },
                    {
                        label: "BK/HK Einnahmen",
                        data: bkIncomeMonthValues,
                        borderColor: "#198754",
                        backgroundColor: "rgba(25, 135, 84, 0.1)",
                        borderWidth: 2,
                        tension: 0.28,
                        fill: false,
                        pointRadius: 2.5,
                    },
                    {
                        label: "BK-Ausgaben",
                        data: bkExpenseMonthValues,
                        borderColor: "#dc3545",
                        backgroundColor: "rgba(220, 53, 69, 0.1)",
                        borderWidth: 2,
                        tension: 0.28,
                        fill: false,
                        pointRadius: 2.5,
                    },
                ],
            },
            options: commonOptions,
        });
    }
})();
</script>
{% endblock %}
