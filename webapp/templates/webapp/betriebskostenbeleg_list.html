{% extends "webapp/base.html" %}
{% load l10n %}
{% block page_title %}Betriebskosten{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold">Betriebskosten</h3>
    <div class="d-flex gap-2">
        <a href="{% url 'betriebskosten_gruppe_list' %}" class="btn btn-light shadow-sm">
            <i class="bi bi-collection me-1"></i> BK-Gruppen
        </a>
        <a href="{% url 'betriebskostenbeleg_create' %}" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> Neuer Beleg
        </a>
    </div>
</div>

<div class="card border-0 shadow-sm mb-3">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-6 col-lg-3">
                <label for="belegSearch" class="form-label mb-1">Suchen</label>
                <input
                    id="belegSearch"
                    type="search"
                    class="form-control"
                    placeholder="Text, Referenz, Liegenschaft, Art"
                    autocomplete="off"
                >
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <label for="belegPropertyFilter" class="form-label mb-1">Liegenschaft</label>
                <select id="belegPropertyFilter" class="form-select">
                    <option value="">Alle Liegenschaften</option>
                </select>
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <label for="belegGroupFilter" class="form-label mb-1">Gruppe</label>
                <select id="belegGroupFilter" class="form-select">
                    <option value="">Alle Gruppen</option>
                </select>
            </div>
            <div class="col-sm-6 col-md-3 col-lg-2">
                <label for="belegArtFilter" class="form-label mb-1">Art</label>
                <select id="belegArtFilter" class="form-select">
                    <option value="">Alle Arten</option>
                </select>
            </div>
            <div class="col-sm-6 col-md-3 col-lg-1">
                <form method="get">
                    <label for="belegYearFilter" class="form-label mb-1">Jahr</label>
                    <select id="belegYearFilter" name="jahr" class="form-select" onchange="this.form.submit()">
                        {% for year in year_choices %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                        {% empty %}
                        <option value="{{ selected_year }}">{{ selected_year }}</option>
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="col-md-12 col-lg-2 text-lg-end">
                <div id="belegCount" class="small text-muted"></div>
            </div>
        </div>
    </div>
</div>

<form method="post" action="{% url 'betriebskostenbeleg_bulk_group_update' %}" id="belegBulkForm">
    {% csrf_token %}
    <input type="hidden" name="next" id="belegBulkNext" value="{% url 'betriebskostenbeleg_list' %}">

    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-6 col-lg-4">
                    <label for="bulkGroupSelect" class="form-label mb-1">Bulk-Aktion: Ausgabengruppe</label>
                    <select id="bulkGroupSelect" name="bulk_group_id" class="form-select">
                        <option value="">Bitte auswählen</option>
                        {% for group in bulk_group_choices %}
                        <option value="{{ group.pk }}">{{ group.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 col-lg-3 d-grid">
                    <button type="submit" class="btn btn-outline-primary">Gruppe zuweisen</button>
                </div>
                <div class="col-lg-5 text-muted small">
                    Mehrfachauswahl über die Checkboxen in der Tabelle.
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 42px;">
                                <input type="checkbox" id="selectAllBelege" class="form-check-input" aria-label="Alle auswählen">
                            </th>
                            <th class="text-center">Aktion</th>
                            <th class="ps-2">
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="datum">
                                    Datum <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th>
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="liegenschaft">
                                    Liegenschaft <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th>
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="gruppe">
                                    Gruppe <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th>
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="art">
                                    Art <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th class="text-end">
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="netto">
                                    Netto <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th class="text-end">
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="ust">
                                    USt % <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th class="text-end">
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="brutto">
                                    Brutto <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th>
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="text">
                                    Text <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                            <th>
                                <button type="button" class="btn btn-link p-0 text-decoration-none text-dark beleg-sort fw-semibold" data-sort-key="referenz">
                                    Import-Referenz <span class="sort-indicator" aria-hidden="true"></span>
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="belegTableBody">
                        {% for beleg in belege %}
                        <tr
                            data-row="1"
                            data-search="{{ beleg.datum|date:'d.m.Y' }} {{ beleg.liegenschaft.name }} {{ beleg.ausgabengruppe.name }} {{ beleg.get_bk_art_display }} {{ beleg.buchungstext|default:'' }} {{ beleg.import_referenz|default:'' }}"
                            data-datum="{{ beleg.datum|date:'Y-m-d' }}"
                            data-liegenschaft="{{ beleg.liegenschaft.name }}"
                            data-gruppe-id="{{ beleg.ausgabengruppe_id }}"
                            data-gruppe-label="{{ beleg.ausgabengruppe.name }}"
                            data-bk-art="{{ beleg.bk_art }}"
                            data-bk-art-label="{{ beleg.get_bk_art_display }}"
                            data-netto="{{ beleg.netto|unlocalize }}"
                            data-ust="{{ beleg.ust_prozent|unlocalize }}"
                            data-brutto="{{ beleg.brutto|unlocalize }}"
                            data-text="{{ beleg.buchungstext|default:'' }}"
                            data-referenz="{{ beleg.import_referenz|default:'' }}"
                        >
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input beleg-select" name="selected_belege" value="{{ beleg.pk }}" aria-label="Beleg {{ beleg.pk }} auswählen">
                            </td>
                            <td class="text-center">
                                <a
                                    href="{% url 'betriebskostenbeleg_update' beleg.pk %}"
                                    data-base-href="{% url 'betriebskostenbeleg_update' beleg.pk %}"
                                    class="btn btn-sm btn-outline-secondary me-1 beleg-edit-link"
                                >
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="{% url 'betriebskostenbeleg_delete' beleg.pk %}" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                            <td class="ps-2">{{ beleg.datum|date:"d.m.Y" }}</td>
                            <td>{{ beleg.liegenschaft.name }}</td>
                            <td>{{ beleg.ausgabengruppe.name }}</td>
                            <td>{{ beleg.get_bk_art_display }}</td>
                            <td class="text-end">{{ beleg.netto }}</td>
                            <td class="text-end">{{ beleg.ust_prozent }}</td>
                            <td class="text-end fw-semibold">{{ beleg.brutto }}</td>
                            <td>{{ beleg.buchungstext|default:"—"|truncatechars:80 }}</td>
                            <td>{{ beleg.import_referenz|default:"—" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center py-5 text-muted">Keine Betriebskostenbelege gefunden.</td>
                        </tr>
                        {% endfor %}
                        <tr id="belegNoResults" class="d-none">
                            <td colspan="11" class="text-center py-5 text-muted">Keine Treffer für den aktuellen Filter.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(() => {
    const tableBody = document.getElementById("belegTableBody");
    if (!tableBody) {
        return;
    }

    const rows = Array.from(tableBody.querySelectorAll("tr[data-row='1']"));
    if (!rows.length) {
        return;
    }

    const searchInput = document.getElementById("belegSearch");
    const propertyFilter = document.getElementById("belegPropertyFilter");
    const groupFilter = document.getElementById("belegGroupFilter");
    const artFilter = document.getElementById("belegArtFilter");
    const countElement = document.getElementById("belegCount");
    const noResultsRow = document.getElementById("belegNoResults");
    const sortButtons = Array.from(document.querySelectorAll(".beleg-sort"));
    const editLinks = Array.from(document.querySelectorAll(".beleg-edit-link"));
    const bulkForm = document.getElementById("belegBulkForm");
    const bulkNextInput = document.getElementById("belegBulkNext");
    const selectAllCheckbox = document.getElementById("selectAllBelege");
    const rowCheckboxes = Array.from(document.querySelectorAll(".beleg-select"));

    const DEFAULT_SORT_KEY = "datum";
    const DEFAULT_SORT_DIRECTION = "desc";
    const QUERY_KEYS = {
        search: "suche",
        property: "liegenschaft",
        group: "gruppe",
        art: "art",
        sort: "sort",
        direction: "richtung",
    };
    const VALID_SORT_KEYS = new Set([
        "datum",
        "liegenschaft",
        "gruppe",
        "art",
        "netto",
        "ust",
        "brutto",
        "text",
        "referenz",
    ]);

    const state = {
        sortKey: DEFAULT_SORT_KEY,
        sortDirection: DEFAULT_SORT_DIRECTION,
    };

    function normalize(value) {
        return String(value || "").toLowerCase().trim();
    }

    function parseNumeric(value) {
        const raw = String(value || "").trim();
        if (!raw) {
            return 0;
        }
        let normalized = raw;
        if (normalized.includes(",") && normalized.includes(".")) {
            normalized = normalized.replace(/\./g, "").replace(",", ".");
        } else if (normalized.includes(",")) {
            normalized = normalized.replace(",", ".");
        }
        const number = Number.parseFloat(normalized);
        return Number.isFinite(number) ? number : 0;
    }

    function compareRows(a, b) {
        const directionFactor = state.sortDirection === "asc" ? 1 : -1;
        const key = state.sortKey;

        if (key === "datum") {
            return (a.dataset.datum || "").localeCompare(b.dataset.datum || "", "de") * directionFactor;
        }
        if (key === "netto") {
            return (parseNumeric(a.dataset.netto) - parseNumeric(b.dataset.netto)) * directionFactor;
        }
        if (key === "ust") {
            return (parseNumeric(a.dataset.ust) - parseNumeric(b.dataset.ust)) * directionFactor;
        }
        if (key === "brutto") {
            return (parseNumeric(a.dataset.brutto) - parseNumeric(b.dataset.brutto)) * directionFactor;
        }

        if (key === "liegenschaft") {
            return normalize(a.dataset.liegenschaft).localeCompare(
                normalize(b.dataset.liegenschaft),
                "de",
                { sensitivity: "base" }
            ) * directionFactor;
        }
        if (key === "gruppe") {
            return normalize(a.dataset.gruppeLabel).localeCompare(
                normalize(b.dataset.gruppeLabel),
                "de",
                { sensitivity: "base" }
            ) * directionFactor;
        }
        if (key === "art") {
            return normalize(a.dataset.bkArtLabel).localeCompare(
                normalize(b.dataset.bkArtLabel),
                "de",
                { sensitivity: "base" }
            ) * directionFactor;
        }
        if (key === "referenz") {
            return normalize(a.dataset.referenz).localeCompare(
                normalize(b.dataset.referenz),
                "de",
                { sensitivity: "base" }
            ) * directionFactor;
        }

        return normalize(a.dataset.text).localeCompare(
            normalize(b.dataset.text),
            "de",
            { sensitivity: "base" }
        ) * directionFactor;
    }

    function fillSelect(selectElement, valuesWithLabel) {
        const keys = Array.from(valuesWithLabel.keys()).sort((a, b) => {
            const left = normalize(valuesWithLabel.get(a));
            const right = normalize(valuesWithLabel.get(b));
            return left.localeCompare(right, "de", { sensitivity: "base" });
        });
        for (const key of keys) {
            const option = document.createElement("option");
            option.value = key;
            option.textContent = valuesWithLabel.get(key);
            selectElement.appendChild(option);
        }
    }

    const propertyValues = new Map();
    const groupValues = new Map();
    const artValues = new Map();
    for (const row of rows) {
        if (row.dataset.liegenschaft) {
            propertyValues.set(row.dataset.liegenschaft, row.dataset.liegenschaft);
        }
        if (row.dataset.gruppeId) {
            groupValues.set(row.dataset.gruppeId, row.dataset.gruppeLabel || row.dataset.gruppeId);
        }
        if (row.dataset.bkArt) {
            artValues.set(row.dataset.bkArt, row.dataset.bkArtLabel || row.dataset.bkArt);
        }
    }
    fillSelect(propertyFilter, propertyValues);
    fillSelect(groupFilter, groupValues);
    fillSelect(artFilter, artValues);

    function applyStateFromQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const searchValue = params.get(QUERY_KEYS.search);
        const propertyValue = params.get(QUERY_KEYS.property);
        const groupValue = params.get(QUERY_KEYS.group);
        const artValue = params.get(QUERY_KEYS.art);
        const sortKey = params.get(QUERY_KEYS.sort);
        const sortDirection = params.get(QUERY_KEYS.direction);

        if (searchValue) {
            searchInput.value = searchValue;
        }
        if (propertyValue && propertyValues.has(propertyValue)) {
            propertyFilter.value = propertyValue;
        }
        if (groupValue && groupValues.has(groupValue)) {
            groupFilter.value = groupValue;
        }
        if (artValue && artValues.has(artValue)) {
            artFilter.value = artValue;
        }
        if (sortKey && VALID_SORT_KEYS.has(sortKey)) {
            state.sortKey = sortKey;
        }
        if (sortDirection === "asc" || sortDirection === "desc") {
            state.sortDirection = sortDirection;
        }
    }

    function syncStateToQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const searchValue = searchInput.value.trim();
        if (searchValue) {
            params.set(QUERY_KEYS.search, searchValue);
        } else {
            params.delete(QUERY_KEYS.search);
        }
        if (propertyFilter.value) {
            params.set(QUERY_KEYS.property, propertyFilter.value);
        } else {
            params.delete(QUERY_KEYS.property);
        }
        if (groupFilter.value) {
            params.set(QUERY_KEYS.group, groupFilter.value);
        } else {
            params.delete(QUERY_KEYS.group);
        }
        if (artFilter.value) {
            params.set(QUERY_KEYS.art, artFilter.value);
        } else {
            params.delete(QUERY_KEYS.art);
        }
        if (state.sortKey !== DEFAULT_SORT_KEY) {
            params.set(QUERY_KEYS.sort, state.sortKey);
        } else {
            params.delete(QUERY_KEYS.sort);
        }
        if (state.sortDirection !== DEFAULT_SORT_DIRECTION) {
            params.set(QUERY_KEYS.direction, state.sortDirection);
        } else {
            params.delete(QUERY_KEYS.direction);
        }

        const queryString = params.toString();
        const targetUrl = queryString ? `${window.location.pathname}?${queryString}` : window.location.pathname;
        const currentUrl = `${window.location.pathname}${window.location.search}`;
        if (targetUrl !== currentUrl) {
            window.history.replaceState(null, "", targetUrl);
        }
    }

    function updateSelectionIndicators() {
        if (!selectAllCheckbox) {
            return;
        }
        const visibleChecked = rows.filter((row) => !row.classList.contains("d-none"))
            .map((row) => row.querySelector(".beleg-select"))
            .filter((checkbox) => checkbox && checkbox.checked);
        const visibleCheckboxes = rows.filter((row) => !row.classList.contains("d-none"))
            .map((row) => row.querySelector(".beleg-select"))
            .filter(Boolean);
        if (!visibleCheckboxes.length) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
        }
        if (visibleChecked.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
        }
        if (visibleChecked.length === visibleCheckboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
            return;
        }
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }

    function updateEditLinksWithNext() {
        if (!editLinks.length) {
            return;
        }
        const nextUrl = `${window.location.pathname}${window.location.search}`;
        if (bulkNextInput) {
            bulkNextInput.value = nextUrl;
        }
        for (const link of editLinks) {
            const baseHref = link.dataset.baseHref || link.getAttribute("href");
            if (!baseHref) {
                continue;
            }
            const editUrl = new URL(baseHref, window.location.origin);
            editUrl.searchParams.set("next", nextUrl);
            link.href = `${editUrl.pathname}?${editUrl.searchParams.toString()}`;
        }
    }

    function updateSortIndicators() {
        for (const button of sortButtons) {
            const indicator = button.querySelector(".sort-indicator");
            if (!indicator) {
                continue;
            }
            if (button.dataset.sortKey !== state.sortKey) {
                indicator.textContent = "";
                indicator.className = "sort-indicator text-muted";
                continue;
            }
            indicator.textContent = state.sortDirection === "asc" ? "▲" : "▼";
            indicator.className = "sort-indicator text-primary";
        }
    }

    function applyFiltersAndSorting() {
        const searchTerm = normalize(searchInput.value);
        const selectedProperty = propertyFilter.value;
        const selectedGroup = groupFilter.value;
        const selectedArt = artFilter.value;

        const visibleRows = [];
        for (const row of rows) {
            const matchesSearch = !searchTerm || normalize(row.dataset.search).includes(searchTerm);
            const matchesProperty = !selectedProperty || row.dataset.liegenschaft === selectedProperty;
            const matchesGroup = !selectedGroup || row.dataset.gruppeId === selectedGroup;
            const matchesArt = !selectedArt || row.dataset.bkArt === selectedArt;
            const isVisible = matchesSearch && matchesProperty && matchesGroup && matchesArt;
            row.classList.toggle("d-none", !isVisible);
            if (isVisible) {
                visibleRows.push(row);
            }
        }

        visibleRows.sort(compareRows);
        for (const row of visibleRows) {
            tableBody.appendChild(row);
        }
        if (noResultsRow) {
            tableBody.appendChild(noResultsRow);
            noResultsRow.classList.toggle("d-none", visibleRows.length > 0);
        }

        if (countElement) {
            countElement.textContent = `${visibleRows.length} von ${rows.length} Belegen`;
        }

        updateSortIndicators();
        syncStateToQueryParams();
        updateEditLinksWithNext();
        updateSelectionIndicators();
    }

    let frameRequested = false;
    function scheduleApply() {
        if (frameRequested) {
            return;
        }
        frameRequested = true;
        window.requestAnimationFrame(() => {
            frameRequested = false;
            applyFiltersAndSorting();
        });
    }

    searchInput.addEventListener("input", scheduleApply);
    propertyFilter.addEventListener("change", scheduleApply);
    groupFilter.addEventListener("change", scheduleApply);
    artFilter.addEventListener("change", scheduleApply);

    for (const button of sortButtons) {
        button.addEventListener("click", () => {
            const nextKey = button.dataset.sortKey;
            if (!nextKey) {
                return;
            }
            if (state.sortKey === nextKey) {
                state.sortDirection = state.sortDirection === "asc" ? "desc" : "asc";
            } else {
                state.sortKey = nextKey;
                state.sortDirection = nextKey === "datum" ? "desc" : "asc";
            }
            scheduleApply();
        });
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", () => {
            for (const row of rows) {
                if (row.classList.contains("d-none")) {
                    continue;
                }
                const checkbox = row.querySelector(".beleg-select");
                if (!checkbox) {
                    continue;
                }
                checkbox.checked = selectAllCheckbox.checked;
            }
            updateSelectionIndicators();
        });
    }

    for (const checkbox of rowCheckboxes) {
        checkbox.addEventListener("change", updateSelectionIndicators);
    }

    if (bulkForm) {
        bulkForm.addEventListener("submit", (event) => {
            const hasSelection = rowCheckboxes.some((checkbox) => checkbox.checked);
            if (!hasSelection) {
                event.preventDefault();
                window.alert("Bitte mindestens einen Beleg auswählen.");
            }
        });
    }

    applyStateFromQueryParams();
    applyFiltersAndSorting();
})();
</script>
{% endblock %}
